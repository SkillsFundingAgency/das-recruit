@using Esfa.Recruit.Shared.Web.Extensions
@using Esfa.Recruit.Vacancies.Client.Domain.Entities
@using Esfa.Recruit.Vacancies.Client.Domain.Extensions
@using Esfa.Recruit.Vacancies.Client.Domain.Models
@model VacanciesListViewModel

@{
    string GetLinkText(VacancyListItemViewModel vacancySummary)
    {
        return vacancySummary.Status switch
        {
            VacancyStatus.Referred or VacancyStatus.Rejected => "Edit and resubmit",
            VacancyStatus.Draft => "Edit and submit",
            VacancyStatus.Review => "Review",
            _ => "Manage"
        };
    }
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <table class="govuk-table das-table--condensed das-table--responsive">
            <caption class="govuk-visually-hidden">Your draft vacancies</caption>
            <thead class="govuk-table__head">
            <tr class="govuk-table__row">
                <th asp-show="@(Model.UserType is UserType.Employer)" class="govuk-table__header" scope="col">Advert title</th>
                <th asp-show="@(Model.UserType is UserType.Employer)" class="govuk-table__header" scope="col">Advert reference number</th>

                <th asp-show="@(Model.UserType is UserType.Provider)" class="govuk-table__header" scope="col">Vacancy title</th>
                <th asp-show="@(Model.UserType is UserType.Provider)" class="govuk-table__header" scope="col">Employer</th>
                <th asp-show="@(Model.UserType is UserType.Provider)" class="govuk-table__header" scope="col">Vacancy reference number</th>

                <th asp-show="@Model.ShowApplicationsColumn" class="govuk-table__header" scope="col">Applications</th>
                
                <das-sortable-column-header 
                    route-data="@Model.RouteDictionary"
                    sort-column="@VacancySortColumn.ClosingDate"
                    default-sort-order="Desc"
                    active-sort-column="@Model.SortColumn"
                    active-sort-order="@Model.SortOrder">
                    Closing date
                </das-sortable-column-header>

                <th class="govuk-table__header" scope="col">Status</th>
                <th class="govuk-table__header govuk-table__header--numeric govuk-!-padding-right-0" scope="col">Action</th>
            </tr>
            </thead>
            <tbody class="govuk-table__body">
            @foreach (var vacancy in Model.Vacancies)
            {
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell" data-label="Vacancy title">
                        <div>@vacancy.Title</div>
                        <govuk-tag-foundation asp-show="@(vacancy.ApprenticeshipType == ApprenticeshipTypes.Foundation)" class="govuk-!-margin-top-2 govuk-!-margin-bottom-1 app-tag"/>
                    </td>
                    <td asp-show="@(Model.UserType is UserType.Provider)" class="govuk-table__cell" data-label="Employer">
                        <span>@vacancy.EmployerName</span>
                    </td>
                    <td class="govuk-table__cell" data-label="Vacancy reference number">
                        <span asp-show="@vacancy.HasVacancyReference"><span>VAC</span>@vacancy.VacancyReference</span>
                        <div class="govuk-!-margin-top-1">
                            <govuk-tag-api-submitted asp-show="@vacancy.SourceOrigin == @SourceOrigin.Api && @Model.ShowSourceOrigin" class="app-tag" />
                        </div>
                    </td>
                    <td asp-show="@(Model.ShowApplicationsColumn && vacancy.CanShowVacancyApplicationsCount)" class="govuk-table__cell" data-label="Applications">
                        <div asp-show="@Model.ShowNewApplicationCounts">
                            <span asp-show="@vacancy.HasNoApplications">0</span>
                            <span asp-show="@vacancy.HasApplications">@vacancy.NoOfApplications</span>
                            <span asp-show="@vacancy.HasNewApplications" class="govuk-!-font-weight-bold">(@vacancy.NoOfNewApplications new)</span>
                        </div>
                        <div asp-show="@Model.ShowEmployerReviewedApplicationCounts">
                            <span asp-show="@vacancy.HasEmployerReviewedApplications">@vacancy.NoOfEmployerReviewedApplications reviewed</span>
                        </div>
                    </td>
                    <td asp-show="@(Model.ShowApplicationsColumn && !vacancy.CanShowVacancyApplicationsCount)" class="govuk-table__cell" data-label="Applications">-</td>
                    <td class="govuk-table__cell" data-label="Closing date"><span>@vacancy.ClosingDate?.AsGdsDate()</span></td>
                    <td class="govuk-table__cell" data-label="Status">
                        <span class="govuk-tag app-tag app-tag--@vacancy.Status.ToString().ToLower()">@vacancy.Status.GetDisplayName(Model.UserType)</span>
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric" data-label="Action">
                        @{
                            var actionRoute = vacancy.IsSubmittable switch
                            {
                                false => Model.ManageVacancyRoute,
                                _ => vacancy.Status switch
                                {
                                    VacancyStatus.Referred or VacancyStatus.Rejected or VacancyStatus.Review => Model.SubmitVacancyRoute,
                                    VacancyStatus.Draft when vacancy.IsTaskListCompleted => Model.SubmitVacancyRoute,
                                    _ => Model.EditVacancyRoute
                                }
                            };
                        }

                        <a id="task-list-@vacancy.Id" asp-route="@actionRoute" asp-all-route-data="@vacancy.RouteDictionary" class="govuk-link">
                            @GetLinkText(vacancy) <span class="govuk-visually-hidden">@vacancy.Title</span>
                        </a>
                    </td>
                </tr>
            }
            </tbody>
        </table>

        <div asp-show="@Model.Pagination.Show" class="das-pagination-container">
            <div class="das-pagination__summary">@Model.Pagination.Caption</div>
            <govuk-pagination
                current-page="@Model.Pagination.CurrentPage"
                page-count="@Model.Pagination.TotalPages"
                route-dictionary="@Model.RouteDictionary" />
        </div>
    </div>
</div>